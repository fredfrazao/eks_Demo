#jinja2: trim_blocks: True, lstrip_blocks: True
# {{ ansible_managed }}
# Generated from 'node.extra' group
# Do not change in-place! In order to change this file first read following link:
# https://git.daimler.com/CCP/platform-infrastructure/tree/master/scripts/prometheus-rules-generator.py
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: "node.extra"
  namespace: {{ k8s_namespace }}
spec:
{% if not prometheus_rules.node %}
  groups: []
{% else %}
  groups:
  - name: node.extra
    rules:
    - alert: HostOutOfMemory
      annotations:
    {% raw %}
        description: "Node memory is filling up (< 30% left)\n  VALUE = {{ $value }} \n  LABELS: {{ $labels }}."
        summary: Host out of memory (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100 < 30
      for: 5m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.sre }}
    - alert: HostMemoryUnderMemoryPressure
      annotations:
    {% raw %}
        description: "The node is under heavy memory pressure. High rate of major page faults\n  VALUE = {{ $value }} \n  LABELS: {{ $labels }}."
        summary: Host memory under memory pressure (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: rate(node_vmstat_pgmajfault[1m]) > 1000
      for: 5m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.sre }}
    - alert: HostOutOfDiskSpace
      annotations:
    {% raw %}
        description: "Disk is almost full (< 30% left)\n  VALUE = {{ $value }} \n  LABELS: {{ $labels }}."
        summary: Host out of disk space (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: (node_filesystem_avail_bytes{mountpoint="/"}  * 100) / node_filesystem_size_bytes{mountpoint="/"} < 30
      for: 5m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.sre }}
    - alert: HostOutOfInodes
      annotations:
    {% raw %}
        description: "Disk is almost running out of available inodes (< 30% left)\n  VALUE = {{ $value }} \n  LABELS: {{ $labels }}."
        summary: Host out of inodes (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: node_filesystem_files_free{mountpoint ="/rootfs"} / node_filesystem_files{mountpoint ="/rootfs"} * 100 < 30
      for: 5m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.sre }}
    - alert: HostUnusualDiskReadLatency
      annotations:
    {% raw %}
        description: "Disk latency is growing (read operations > 100ms)\n  VALUE = {{ $value }} \n  LABELS: {{ $labels }}."
        summary: Host unusual disk read latency (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: rate(node_disk_read_time_seconds_total[1m]) / rate(node_disk_reads_completed_total[1m]) > 0.1
      for: 5m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.sre }}
    - alert: HostUnusualDiskWriteLatency
      annotations:
    {% raw %}
        description: "Disk latency is growing (write operations > 100ms)\n  VALUE = {{ $value }} \n  LABELS: {{ $labels }}."
        summary: Host unusual disk write latency (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: rate(node_disk_write_time_seconds_total[1m]) / rate(node_disk_writes_completed_total[1m]) > 0.1
      for: 5m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.sre }}
    - alert: HostHighCpuLoad
      annotations:
    {% raw %}
        description: "CPU load is > 70%\n  VALUE = {{ $value }} \n  LABELS: {{ $labels }}."
        summary: Host high CPU load (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 70
      for: 5m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.sre }}
    - alert: HostSwapIsFillingUp
      annotations:
    {% raw %}
        description: "Swap is filling up (>70%)\n  VALUE = {{ $value }} \n  LABELS: {{ $labels }}."
        summary: Host swap is filling up (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: (1 - (node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes)) * 100 > 70
      for: 5m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.sre }}
    - alert: HostPhysicalComponentTooHot
      annotations:
    {% raw %}
        description: "Physical hardware component too hot\n  VALUE = {{ $value }} \n  LABELS: {{ $labels }}."
        summary: Host physical component too hot (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: node_hwmon_temp_celsius > 75
      for: 5m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.sre }}
    - alert: HostRaidArrayGotInactive
      annotations:
    {% raw %}
        description: "RAID array {{ $labels.device }}  is in degraded state due to one or more disks failures. Number of spare drives is insufficient to fix issue automatically.\n  VALUE = {{ $value }} \n  LABELS: {{ $labels }}."
        summary: Host RAID array got inactive (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: node_md_state{state="inactive"} > 0
      for: 5m
      labels:
        severity: critical
        notify_team: {{ prometheus_alert_teams.sre }}
    - alert: HostRaidDiskFailure
      annotations:
    {% raw %}
        description: "At least one device in RAID array on {{ $labels.instance }}  failed. Array {{ $labels.md_device }}  needs attention and possibly a disk swap\n  VALUE = {{ $value }} \n  LABELS: {{ $labels }}."
        summary: Host RAID disk failure (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: node_md_disks{state="failed"} > 0
      for: 5m
      labels:
        severity: critical
        notify_team: {{ prometheus_alert_teams.sre }}
    - alert: HostEdacCorrectableErrorsDetected
      annotations:
    {% raw %}
        description: "{{ $labels.instance }}  has had {{  printf \"%.0f\" $value }}  correctable memory errors reported by EDAC in the last 5 minutes.\n  VALUE = {{ $value }} \n  LABELS: {{ $labels }}."
        summary: Host EDAC Correctable Errors detected (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: increase(node_edac_correctable_errors_total[5m]) > 0
      for: 5m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.sre }}
    - alert: HostEdacUncorrectableErrorsDetected
      annotations:
    {% raw %}
        description: "{{ $labels.instance }}  has had {{  printf \"%.0f\" $value }}  uncorrectable memory errors reported by EDAC in the last 5 minutes.\n  VALUE = {{ $value }} \n  LABELS: {{ $labels }}."
        summary: Host EDAC Uncorrectable Errors detected (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: node_edac_uncorrectable_errors_total > 0
      for: 5m
      labels:
        severity: critical
        notify_team: {{ prometheus_alert_teams.sre }}
    - alert: CumulusPhysicalComponentTooHot
      annotations:
    {% raw %}
        description: "Cumulus physical hardware component too hot\n  VALUE = {{ $value }} \n  LABELS: {{ $labels }}."
        summary: Cumulus physical component too hot (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: cumulus_sensor_temperature_celsius > 75
      for: 5m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.sre }}
    - alert: CumulusPhysicalComponentTooCold
      annotations:
    {% raw %}
        description: "Cumulus physical hardware component too cold\n  VALUE = {{ $value }} \n  LABELS: {{ $labels }}."
        summary: Cumulus physical component too cold (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: cumulus_sensor_temperature_celsius < 10
      for: 5m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.sre }}
{% endif %}
