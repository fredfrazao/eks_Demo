#jinja2: trim_blocks: True, lstrip_blocks: True
# {{ ansible_managed }}
# Generated from 'network.extra' group
# Do not change in-place! In order to change this file first read following link:
# https://git.daimler.com/CCP/platform-infrastructure/tree/master/scripts/prometheus-rules-generator.py
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: "network.extra"
  namespace: {{ k8s_namespace }}
spec:
{% if not prometheus_rules.network %}
  groups: []
{% else %}
  groups:
  - name: network.extra
    rules:
    - alert: BondDegraded
      annotations:
    {% raw %}
        description: Bond is degraded on (instance {{ $labels.instance }} ).
        summary: Bond {{ $labels.master }} is degraded on (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: (node_bonding_active - node_bonding_slaves) != 0
      for: 1m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.barekube }}
    - alert: NodeNetworkInterfaceIsDown
      annotations:
    {% raw %}
        description: Network interface is down on (instance {{ $labels.instance }} ).
        summary: Network interface {{ $labels.master }} status is down on (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: resets(node_network_up{device!~"lo|veth.+|vnet.+|br.+|virbr.+"}[1d]) > 0 and (node_network_up{device!~"lo|veth.+|vnet.+"}) == 0
      for: 1m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.barekube }}
    - alert: NodeNetworkInterfaceFlapping
      annotations:
    {% raw %}
        description: Network interface {{ $labels.device }} changing its up status often on (instance {{ $labels.instance }} ).
        summary: Network interface is flapping on (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: changes(node_network_up{device!~"veth.+|vnet.+|br.+"}[2m]) > 2
      for: 2m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.barekube }}
    - alert: NodeNetworkReceiveErrors
      annotations:
    {% raw %}
        description: Network interface {{ $labels.device }} has receive errors on (instance {{ $labels.instance }} ).
        summary: Network interface has receive errors on (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: rate(node_network_receive_errs_total[2m]) / rate(node_network_receive_packets_total[2m]) > 0.01
      for: 2m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.barekube }}
    - alert: NodeNetworkTransmitErrors
      annotations:
    {% raw %}
        description: Network interface {{ $labels.device }} has transmit errors on (instance {{ $labels.instance }} ).
        summary: Network interface has transmit errors on (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: rate(node_network_transmit_errs_total[2m]) / rate(node_network_transmit_packets_total[2m]) > 0.01
      for: 2m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.barekube }}
    - alert: NodeNetworkCarrierDown
      annotations:
    {% raw %}
        description: Network carrier for interface {{ $labels.device }} is down on (instance {{ $labels.instance }} ).
        summary: Network carrier is down on (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: (node_network_carrier{device=~"enp.+|eno.+|eth.+|swp.+"}) == 0
      for: 1m
      labels:
        severity: critical
        notify_team: {{ prometheus_alert_teams.barekube }}
    - alert: BGPPeerStateDown
      annotations:
    {% raw %}
        description: BGP peering is down on (instance {{ $labels.instance }} ).
        summary: BGP peering is down on (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: frr_bgp_peer_state == 0
      for: 1m
      labels:
        severity: critical
        notify_team: {{ prometheus_alert_teams.barekube }}
    - alert: BGPPeerFlapping
      annotations:
    {% raw %}
        description: BGP peering is flapping on (instance {{ $labels.instance }} ).
        summary: BGP peering is flapping on (instance {{ $labels.instance }} ).
    {% endraw %}
      expr: delta(frr_bgp_peer_uptime_seconds[1m]) > 120
      for: 1m
      labels:
        severity: critical
        notify_team: {{ prometheus_alert_teams.barekube }}
{% endif %}
