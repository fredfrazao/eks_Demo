#jinja2: trim_blocks: True, lstrip_blocks: True
# {{ ansible_managed }}
# Generated from 'quorum-alert.rules' group
# Do not change in-place! In order to change this file first read following link:
# https://git.daimler.com/CCP/platform-infrastructure/tree/master/scripts/prometheus-rules-generator.py
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: "quorum-alert.rules"
  namespace: {{ k8s_namespace }}
spec:
{% if not prometheus_rules.ceph %}
  groups: []
{% else %}
  groups:
  - name: quorum-alert.rules
    rules:
    - alert: CephMonQuorumAtRisk
      annotations:
        description: Storage cluster quorum is low. Contact Support.
        message: Storage quorum at risk
        severity_level: error
        storage_type: ceph
      expr: count(ceph_mon_quorum_status{job="ceph-exporter"} == 1) by (namespace) <= (floor(count(ceph_mon_metadata{job="ceph-exporter"}) by (namespace) / 2) + 1)
      for: 15m
      labels:
        severity: critical
        notify_team: {{ prometheus_alert_teams.ceph }}
    - alert: CephMonQuorumLost
      annotations:
        description: Storage cluster quorum is lost. Contact Support.
        message: Storage quorum is lost
        severity_level: critical
        storage_type: ceph
      expr: count(kube_pod_status_phase{pod=~"rook-ceph-mon-.*", phase=~"Running|running"} == 1) by (namespace) < 2
      for: 5m
      labels:
        severity: critical
        notify_team: {{ prometheus_alert_teams.ceph }}
    - alert: CephMonHighNumberOfLeaderChanges
      annotations:
    {% raw %}
        description: Ceph Monitor {{ $labels.ceph_daemon }} on host {{ $labels.hostname }} has seen {{ $value | printf "%.2f" }} leader changes per minute recently.
    {% endraw %}
        message: Storage Cluster has seen many leader changes recently.
        severity_level: warning
        storage_type: ceph
      expr: (ceph_mon_metadata{job="ceph-exporter"} * on (ceph_daemon) group_left() (rate(ceph_mon_num_elections{job="ceph-exporter"}[5m]) * 60)) > 0.95
      for: 5m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.ceph }}
{% endif %}
