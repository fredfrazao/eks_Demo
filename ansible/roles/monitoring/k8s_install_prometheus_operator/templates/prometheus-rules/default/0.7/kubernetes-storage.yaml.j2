#jinja2: trim_blocks: True, lstrip_blocks: True
# {{ ansible_managed }}
# Generated from 'kubernetes-storage' group
# Do not change in-place! In order to change this file first read following link:
# https://git.daimler.com/CCP/platform-infrastructure/tree/master/scripts/prometheus-rules-generator.py
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: "kubernetes-storage"
  namespace: {{ k8s_namespace }}
spec:
{% if not prometheus_rules.kubernetesStorage %}
  groups: []
{% else %}
  groups:
  - name: kubernetes-storage
    rules:
    - alert: KubePersistentVolumeFillingUp
      annotations:
    {% raw %}
        description: The PersistentVolume claimed by {{ $labels.persistentvolumeclaim }} in Namespace {{ $labels.namespace }} is only {{ $value | humanizePercentage }} free.
    {% endraw %}
        runbook_url: https://github.com/prometheus-operator/kube-prometheus/wiki/kubepersistentvolumefillingup
        summary: PersistentVolume is filling up.
      expr: |-
        (
          kubelet_volume_stats_available_bytes{job="kubelet", namespace=~"{{ prometheus_namespaces }}", metrics_path="/metrics"}
            /
          kubelet_volume_stats_capacity_bytes{job="kubelet", namespace=~"{{ prometheus_namespaces }}", metrics_path="/metrics"}
            < 0.03
        ) {{ prometheus_extend_team_label }}
      for: 1m
      labels:
        severity: critical
        notify_team: {{'"{{'}} $labels.{{ prometheus_namespace_team_label }}{{'}}"'}}
    - alert: KubePersistentVolumeFillingUp
      annotations:
    {% raw %}
        description: Based on recent sampling, the PersistentVolume claimed by {{ $labels.persistentvolumeclaim }} in Namespace {{ $labels.namespace }} is expected to fill up within four days. Currently {{ $value | humanizePercentage }} is available.
    {% endraw %}
        runbook_url: https://github.com/prometheus-operator/kube-prometheus/wiki/kubepersistentvolumefillingup
        summary: PersistentVolume is filling up.
      expr: |-
        (
          (
            kubelet_volume_stats_available_bytes{job="kubelet", namespace=~"{{ prometheus_namespaces }}", metrics_path="/metrics"}
              /
            kubelet_volume_stats_capacity_bytes{job="kubelet", namespace=~"{{ prometheus_namespaces }}", metrics_path="/metrics"}
          ) < 0.15
          and
          predict_linear(kubelet_volume_stats_available_bytes{job="kubelet", namespace=~"{{ prometheus_namespaces }}", metrics_path="/metrics"}[6h], 4 * 24 * 3600) < 0
        ) {{ prometheus_extend_team_label }}
      for: 1h
      labels:
        severity: warning
        notify_team: {{'"{{'}} $labels.{{ prometheus_namespace_team_label }}{{'}}"'}}
    - alert: KubePersistentVolumeErrors
      annotations:
    {% raw %}
        description: The persistent volume {{ $labels.persistentvolume }} has status {{ $labels.phase }}.
    {% endraw %}
        runbook_url: https://github.com/prometheus-operator/kube-prometheus/wiki/kubepersistentvolumeerrors
        summary: PersistentVolume is having issues with provisioning.
      expr: |-
        (
          kube_persistentvolume_status_phase{phase=~"Failed|Pending",job="{{ prometheus_operator_chart_release_name }}-kube-state-metrics", namespace=~"{{ prometheus_namespaces }}"} > 0
        ) {{ prometheus_extend_team_label }}
      for: 5m
      labels:
        severity: critical
        notify_team: {{'"{{'}} $labels.{{ prometheus_namespace_team_label }}{{'}}"'}}
{% endif %}
