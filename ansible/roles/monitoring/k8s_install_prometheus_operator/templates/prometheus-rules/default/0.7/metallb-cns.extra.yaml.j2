#jinja2: trim_blocks: True, lstrip_blocks: True
# {{ ansible_managed }}
# Generated from 'metallb-cns.extra' group
# Do not change in-place! In order to change this file first read following link:
# https://git.daimler.com/CCP/platform-infrastructure/tree/master/scripts/prometheus-rules-generator.py
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: "metallb-cns.extra"
  namespace: {{ k8s_namespace }}
spec:
{% if not prometheus_rules.metallb %}
  groups: []
{% else %}
  groups:
  - name: metallb-cns.extra
    rules:
    - alert: MetallbPublicIPAllocationAlmostFull
      annotations:
        description: Raises when metallb public ip allocation is at over 70% capacity.
    {% raw %}
        summary: The {{ $labels.cluster }} currently has over 70% of its Public IP available allocated.
    {% endraw %}
      expr: metallb_allocator_addresses_in_use_total{pool="public-ip-pool"} / metallb_allocator_addresses_total{pool="public-ip-pool"} * 100 > 70
      for: 15m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.cns }}
    - alert: MetallbPublicIPAllocationFull
      annotations:
        description: Raises when metallb public ip allocation is at 100% capacity.
    {% raw %}
        summary: The {{ $labels.cluster }} currently has 100% of its Public IP available allocated.
    {% endraw %}
      expr: metallb_allocator_addresses_in_use_total{pool="public-ip-pool"} / metallb_allocator_addresses_total{pool="public-ip-pool"} * 100 == 100
      for: 5m
      labels:
        severity: critical
        notify_team: {{ prometheus_alert_teams.cns }}
    - alert: MetallbPrivateIPAllocationAlmostFull
      annotations:
        description: Raises when metallb private ip allocation is at over 70% capacity.
    {% raw %}
        summary: The {{ $labels.cluster }} currently has over 70% of its private IP available allocated.
    {% endraw %}
      expr: metallb_allocator_addresses_in_use_total{pool="default"} / metallb_allocator_addresses_total{pool="default"} * 100 > 70
      for: 15m
      labels:
        severity: warning
        notify_team: {{ prometheus_alert_teams.cns }}
    - alert: MetallbPrivateIPAllocationFull
      annotations:
        description: Raises when metallb private ip allocation is at 100% capacity.
    {% raw %}
        summary: The {{ $labels.cluster }} currently has 100% of its private IP available allocated.
    {% endraw %}
      expr: metallb_allocator_addresses_in_use_total{pool="default"} / metallb_allocator_addresses_total{pool="default"} * 100 == 100
      for: 5m
      labels:
        severity: critical
        notify_team: {{ prometheus_alert_teams.cns }}
{% endif %}
